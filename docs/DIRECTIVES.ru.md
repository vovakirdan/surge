# Директивы Surge
[English](DIRECTIVES.md) | [Russian](DIRECTIVES.ru.md)

Директивы Surge — это **структурированные блоки doc-комментариев** (`///`), которые позволяют прикреплять к коду сценарии, управляемые инструментами (тесты, бенчмарки, проверки линтера).

Этот документ описывает **текущее поведение (v1)** и **запланированный roadmap**.

---

## 1. Текущий статус (v1)

### 1.1 Что реализовано

- Директивы **парсятся**, когда включен флаг `--directives=collect|gen|run`.
- Каждый блок директивы **прикрепляется к следующему элементу** в файле (функции/типу/let/и т.д.).
- Компилятор **валидирует пространства имен (namespaces)** директив относительно импортов, когда директивы включены.
- `--directives=run` запускает **стаб-раннер (stub runner)**, который печатает сценарии как *SKIPPED* (пока нет кодогенерации/выполнения).

### 1.2 Что *не* реализовано

- Нет генерации кода директив.
- Нет проверки типов тела директивы или выполнения.
- Имена сценариев (именованные тест-кейсы) пока не поддерживаются.

---

## 2. Реализованный синтаксис (v1)

Блок директивы — это **непрерывный блок `///`**, содержащий:

1) Первая непустая строка: `<namespace>:`
2) Следующие строки: должны начинаться с `<namespace>.` или `<namespace>::`

Пример:

```sg
import stdlib/directives::test;

/// test:
/// test.eq(add(1, 2), 3)
/// test.eq(add(2, 2), 4)
fn add(a: int, b: int) -> int { return a + b; }
```

Заметки:
- Пустая строка `///` **завершает** блок директивы.
- Любой блок `///`, который **не** соответствует правилам пространства имен, рассматривается как обычный doc-комментарий.
- Пространства имен должны быть валидными идентификаторами (`[A-Za-z_][A-Za-z0-9_]*`).

---

## 3. Валидация пространств имен (реализовано)

Когда включено `--directives=collect|gen|run`, компилятор проверяет:

1) Пространство имен (`test` в `/// test:`) **должно быть импортированным модулем**.
2) Этот модуль должен иметь `pragma directive`.

Диагностика:

| Код | Ошибка |
|------|-------|
| `SemaDirectiveUnknownNamespace` | Пространство имен директивы не является импортированным модулем |
| `SemaDirectiveNotDirectiveModule` | Модуль пространства имен директивы не имеет `pragma directive` |

---

## 4. Флаги CLI (реализовано)

```bash
surge diag --directives=off|collect|gen|run --directives-filter=test,bench
```

- `off` (по умолчанию): директивы игнорируются.
- `collect`: директивы парсятся и пространства имен валидируются.
- `gen`: в настоящее время ведет себя как `collect` (зарезервировано для будущей кодогенерации).
- `run`: запускает **стаб-раннер** (печатает SKIPPED для каждого сценария).

`--directives-filter` в настоящее время влияет **только** на режим `run` (что печатает стаб).
Фильтр по умолчанию — `test`. Пустой фильтр (`--directives-filter=`) запускает все пространства имен.

---

## 5. Модули директив (реализовано)

Модуль директив — это **обычный модуль Surge**, помеченный:

```sg
pragma directive
```

Он может экспортировать вспомогательные функции, используемые внутри блоков директив.

Пример:

```sg
// stdlib/directives/test.sg
pragma directive

pub fn eq<T>(a: T, b: T) -> bool { return a == b; }
```

---

## 6. Запланированный синтаксис (roadmap)

Следующая структура запланирована, но **пока не реализована**:

```sg
/// test:
/// SumIsCorrect:
///     test.eq(add(1, 2), 3)
```

Запланированные правила:
- Имена `<scenario>` уникальны в пределах файла.
- Тела — полноценные инструкции Surge.
- Тела директив проходят проверку типов в сгенерированном модуле.

---

## 7. Запланированная кодогенерация и выполнение (roadmap)

Будущие режимы `gen/run` будут:

- Генерировать скрытый модуль с одной функцией на блок директивы.
- Проверять типы тел директив.
- Выполнять их через раннер директив.

Это пока не подключено; текущий раннер — заглушка.

---

## 8. Быстрые примеры (текущие)

```sg
import stdlib/directives::test;

/// test:
/// test.eq(len("hi"), 2)
fn foo() -> nothing { return nothing; }
```

```bash
surge diag --directives=collect file.sg
surge diag --directives=run --directives-filter=test file.sg
```
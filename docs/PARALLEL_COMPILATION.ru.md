# Параллельная диагностика и кэширование в Surge
[English](PARALLEL_COMPILATION.md) | [Russian](PARALLEL_COMPILATION.ru.md)

Этот документ описывает, как компилятор Surge распараллеливает **диагностику** и
как он использует **кэши в памяти и на диске** для ускорения повторных запусков.

> Область: `surge diag` на директориях. Запуски на одиночных файлах в основном последовательны.

---

## 1. Обзор

Когда вы запускаете диагностику на директории, Surge использует **параллелизм на уровне файлов**
плюс **пакетно-параллельное вычисление хешей** для графа модулей:

- **Параллелизм на уровне файлов:** токенизация, парсинг, символы и семантика запускаются в
  рабочих горутинах компилятора (Go), ограниченных флагом `--jobs`.
- **Фаза графа модулей:** включаются только файлы, импортирующие модули проекта.
- **Пакетное вычисление хешей:** хеши модулей вычисляются в порядке зависимостей
  параллельными пакетами (batches).

---

## 2. Параллелизм на уровне файлов

```bash
surge diag path/to/dir --jobs=8
```

- `--jobs=0` (по умолчанию) использует `GOMAXPROCS(0)`.
- Каждый `.sg` файл анализируется независимо в воркере.
- Реализация: `internal/driver/parallel_diagnose.go`.

### 2.1. Классификация файлов

Чтобы избежать ненужной работы с графом, файлы классифицируются по импортам:

- **FileFullyIndependent:** нет импортов
- **FileStdlibOnly:** импортирует только модули stdlib
- **FileDependent:** импортирует модули проекта

Модули stdlib определяются по **первому сегменту пути** каждого импорта.
Текущий список:

- `option`
- `result`
- `bounded`
- `saturating_cast`
- `core`

Только файлы **FileDependent** попадают в фазу графа модулей.

Реализация: `internal/driver/parallel_diagnose_helpers.go`.

---

## 3. Граф модулей и Хеши

После анализа по файлам, Surge строит граф зависимостей модулей и вычисляет
хеши в **топологических пакетах**:

- Топологическая сортировка Кана (Kahn) создает пакеты независимых узлов.
- Пакеты обрабатываются **в обратном порядке** (зависимости сначала).
- Каждый пакет вычисляется параллельно с использованием горутин Go + `sync.WaitGroup`.

Реализация: `internal/driver/hashcalc.go`.

Формула хеша:

```
ModuleHash = H(ContentHash || DepHash1 || DepHash2 ...)
```

Зависимости упорядочиваются детерминированно строителем графа.

---

## 4. Кэширование

### 4.1. Кэш в памяти (на запуск)

Общий кэш в памяти хранит метаданные модулей во время одного вызова.
Он используется всеми воркерами и защищен `sync.RWMutex`.

Реализация: `internal/driver/modulecache.go`.

### 4.2. Дисковый кэш (опционально)

Включить с помощью:

```bash
surge diag path/to/dir --disk-cache
```

Заметки:

- Дисковый кэш является **экспериментальным** и в настоящее время хранит **только метаданные модулей**.
- Он используется **только в запусках на директории** (`parallel_diagnose`).
- Записи включают версию схемы; несовпадения рассматриваются как промахи кэша.
- Расположение кэша:
  - `${XDG_CACHE_HOME}/surge/mods/`, если установлено
  - иначе `~/.cache/surge/mods/`
- Файлы — msgpack (`.mp`), ключи — хеши.

Реализация: `internal/driver/dcache.go`.

**Когда дисковый кэш помогает:** большие проекты с дорогими графами модулей.
**Когда он вредит:** маленькие проекты, где доминирует ввод/вывод (кэш может быть медленнее).

---

## 5. Тайминги и Метрики

Включить тайминги для разбивки по файлам и фазе графа модулей:

```bash
surge diag path/to/dir --timings
```

Когда включено `--timings`, Surge также выдает **сводку метрик** как
информационную диагностику, например:

```
Parallel processing metrics: workers: 120 completed, 0 errors | cache: mem=12/120 (10.0%), disk=0/12 (0.0%) | files: 120 total (90 indep, 20 stdlib, 10 dep) | batches: 4 (avg=2.5, max=5)
```

Отслеживаемые метрики:

- Активность воркеров (активные/завершенные/ошибки)
- Уровень попаданий/промахов кэша (память + диск)
- Распределение классификации файлов
- Количество и размеры пакетов для хешей модулей

---

## 6. Заметки о производительности

- Парсинг является доминирующей статьей расходов для большинства реальных кодовых баз, и он уже
  распараллелен на уровне файлов.
- Вычисление хешей модулей выигрывает от пакетного параллелизма, но обычно составляет
  меньшую долю общего времени.
- Семантический анализ в настоящее время не распараллелен **между модулями** из-за
  общего разрешения символов и импортов.

---

## 7. Устранение неполадок

**Диагностика кажется зависшей или нестабильной:**

```bash
surge diag path/to/dir --jobs=1
```

**Очистить дисковый кэш:**

```bash
rm -rf ~/.cache/surge/mods/
```

**Уменьшить шум вывода:**

```bash
surge diag path/to/dir --no-warnings
```

---

## 8. Ключевые места в коде

- Параллельная диагностика: `internal/driver/parallel_diagnose.go`
- Классификация файлов: `internal/driver/parallel_diagnose_helpers.go`
- Граф модулей и хеши: `internal/project/dag`, `internal/driver/hashcalc.go`
- Кэш памяти: `internal/driver/modulecache.go`
- Дисковый кэш: `internal/driver/dcache.go`
- Флаги CLI: `cmd/surge/diagnose.go`

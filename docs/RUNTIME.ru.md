# Рантайм Surge (VM)
[English](RUNTIME.md) | [Russian](RUNTIME.ru.md)

Этот документ описывает текущий рантайм Surge v1. Рантайм — это
однопоточная VM, которая интерпретирует MIR и исполняет async-задачи.

См. также: `docs/IR.ru.md`, `docs/CONCURRENCY.ru.md`, `docs/ABI_LAYOUT.ru.md`.

---

## 1. Обзор

- Компилятор понижает исходники в MIR и исполняет их в VM
  (`internal/vm`).
- Исполнение начинается с синтетической `__surge_start`, созданной
  lowering-ом `@entrypoint`.
- VM — дефолтный backend для `surge run` и по умолчанию использует
  детерминированное планирование.

---

## 2. Архитектура VM

- **Прямой интерпретатор MIR:** инструкции и терминаторы выполняются
  пошагово (`VM.Step`).
- **Стек фреймов + локалы:** каждый вызов пушит `Frame` с локалами и
  instruction pointer.
- **Heap-объекты:** массивы, строки, структуры, tagged unions и другие
  владеемые значения живут в VM heap (`internal/vm/heap.go`).
- **ABI-осознанность:** правила layout задаются `layout.LayoutEngine`
  (см. `docs/ABI_LAYOUT.ru.md`).
- **Drop/RAII:** значения явно дропаются в VM; порядок drop-а трассируется
  в тестах и валидируется intrinsics.

---

## 3. Интерфейс хост-рантайма

VM общается с внешним миром через `Runtime` (`internal/vm/runtime.go`):

- `Argv()` даёт аргументы программы для `@entrypoint("argv")`.
- `StdinReadAll()` обслуживает `@entrypoint("stdin")`.
- `Exit(code)` фиксирует код выхода и завершает исполнение.

Реализации:

- `DefaultRuntime` использует argv/stdin ОС.
- `TestRuntime` даёт контролируемые входы для тестов.
- `RecordingRuntime` и `ReplayRuntime` обеспечивают детерминированный
  record/replay.

---

## 4. Intrinsics и IO

Многие базовые операции реализованы как VM-интринсики, включая:

- числовые преобразования и проверки границ
- операции со строками и массивами
- IO-хелперы (stdout write, stdin read)
- async-примитивы (task handles, channels, timers)

`@intrinsic`-декларации в стандартной библиотеке мапятся на эти реализации.

---

## 5. Async-рантайм

За async отвечает `internal/asyncrt`:

- **Однопоточный executor** с кооперативным планированием.
- **Детерминированный FIFO** по умолчанию; есть fuzz-планирование с
  фиксированным seed для воспроизводимых interleavings.
- **Задачи — state machines**, созданные async lowering-ом (`poll`-функции).
- **Scopes** отслеживают structured concurrency и дочерние задачи.
- **Каналы** — типизированные FIFO очереди с блокирующими и неблокирующими
  операциями.
- **Таймеры** реализуют `sleep` и `timeout` через виртуальное время.

См. `docs/CONCURRENCY.ru.md` для модели на уровне языка.

---

## 6. Детерминизм и replay

VM умеет записывать и воспроизводить выполнение:

- `Recorder` пишет детерминированный NDJSON лог intrinsics, exit и panic.
- `Replayer` проигрывает лог и проверяет каждый результат.
- `RecordingRuntime` оборачивает рантайм и пишет argv/stdin, а
  `ReplayRuntime` выдаёт записанные значения и паникует на несовпадениях.

Это используется в golden-тестах и проверках детерминизма.

---

## 7. Трассировка и отладка

- `surge run --vm-trace` включает трассировку исполнения VM.
- VM экспортирует stop points (имя функции, блок, instruction pointer)
  для отладки и тестовых хелперов.

---

## 8. Известные ограничения (v1)

- Нет параллелизма на уровнях ОС-потоков (однопоточный рантайм).
- `parallel` / `signal` зарезервированы и отклоняются.
- `await` внутри циклов не поддержан async lowering-ом.

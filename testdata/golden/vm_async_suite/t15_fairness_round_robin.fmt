async fn worker(ch: own Channel<int>, id: int) -> int {
    let i = 0;
    while i < 3 {
        ch.send(id);
        checkpoint().await();
        i = i + 1;
    }
    return 0;
}

@entrypoint
fn main() -> int {
    let ch = make_channel::<int>(0);

    let ch0 = ch;
    let ch1 = ch;
    let ch2 = ch;
    let ch3 = ch;
    let ch4 = ch;

    let w0 = spawn worker(ch0, 0);
    let w1 = spawn worker(ch1, 1);
    let w2 = spawn worker(ch2, 2);
    let w3 = spawn worker(ch3, 3);
    let w4 = spawn worker(ch4, 4);

    let total = 15;
    let got = 0;
    let done = false;
    while got < total && !done {
        let v = ch.recv();
        let pair: (bool, int) = compare v {
            Some(x) => (true, x);
            nothing => (false, 0);
        };
        if pair.0 {
            print("v=" + (pair.1 to string));
            got = got + 1;
        } else {
            done = true;
        }
    }

    let _ = w0.await();
    let _ = w1.await();
    let _ = w2.await();
    let _ = w3.await();
    let _ = w4.await();
    return 0;
}
